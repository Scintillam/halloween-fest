---
import '../assets/css/global.css'
import "../assets/css/base.css"
import "../assets/css/typography.css"
import "../assets/css/layout.css"
import "../assets/css/buttons.css"
/* NEW: effetti e animazioni leggere */
import "../assets/css/effects.css"

import { Font } from 'astro:assets'
import Image from "astro/components/Image.astro"

import FooterMain from "../components/FooterMain.astro"
import HeaderMain from "../components/HeaderMain.astro"

// background hero
import bg_image from "../assets/theme-images/locandina.webp"

// Props dalla pagina
const { title, description, settings, lang = "es" } = Astro.props

// Canonical per lingua
const canonicalUrl = settings?.base_url + (lang === "es" ? "/" : `/${lang}/`)

// === CONFIG ===
const pixelId = import.meta.env.PUBLIC_FB_PIXEL_ID ?? "1227221879183874"

// OG image assoluta
const ogImage = settings.base_url + settings.social_image

// JSON-LD Event
const jsonLdEvent = {
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "HLWN FEST Barcelona 2025 – Halloween Party",
  "startDate": "2025-10-31T19:00:00+02:00",
  "endDate": "2025-11-01T02:30:00+02:00",
  "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
  "eventStatus": "https://schema.org/EventScheduled",
  "location": { "@type": "Place", "name": "Estació de França", "address": "Barcelona, Spain" },
  "image": [ogImage],
  "description": "Festival di Halloween con concerti, DJ, rumba catalana e un’atmosfera immersiva nel cuore di Barcellona. Biglietti da 10 €.",
  "offers": { "@type": "AggregateOffer", "lowPrice": "10", "highPrice": "15", "priceCurrency": "EUR", "url": settings?.base_url },
  "organizer": { "@type": "Organization", "name": "FENLES" }
}

// path privacy localizzato
const privacyPath = lang === "en" ? "/en/privacy" : lang === "it" ? "/it/privacy" : "/privacy";
---

<html lang={lang}>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{ title ?? settings.title }</title>
    <meta name="description" content={ description ?? settings.description } />
    <meta name="theme-color" content={ settings.theme_color } />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" href={settings.base_url + '/'} hreflang="es" />
    <link rel="alternate" href={settings.base_url + '/ca/'} hreflang="ca" />
    <link rel="alternate" href={settings.base_url + '/en/'} hreflang="en" />
    <link rel="alternate" href={settings.base_url + '/it/'} hreflang="it" />
    <link rel="alternate" href={settings.base_url + '/'} hreflang="x-default" />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={ title ?? settings.title } />
    <meta property="og:description" content={ description ?? settings.description } />
    <meta property="og:url" content={ canonicalUrl } />
    <meta property="og:image" content={ ogImage } />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ title ?? settings.title } />
    <meta name="twitter:description" content={ description ?? settings.description } />
    <meta name="twitter:image" content={ ogImage } />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/manifest.json" />

    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-inter-display" preload />

    <script type="application/ld+json" is:inline>{JSON.stringify(jsonLdEvent)}</script>

    <!-- GDPR helpers / pixel loader rimangono invariati … -->
    <script is:inline>
      window.fenlesConsent = {
        key: 'fenles_consent_v1',
        get(){try{const r=document.cookie.split('; ').find(x=>x.startsWith(this.key+'='));return r?JSON.parse(decodeURIComponent(r.split('=')[1])):{}}catch{return{}}},
        set(o){const v=encodeURIComponent(JSON.stringify(o));const exp=new Date(Date.now()+31536e6).toUTCString();document.cookie=this.key+'='+v+'; Path=/; Expires='+exp+'; SameSite=Lax'},
        clear(){document.cookie=this.key+'=; Max-Age=0; Path=/; SameSite=Lax'},
        hasMarketing(){return !!this.get().marketing}, hasDecided(){return 'marketing' in this.get()}
      };
      window.loadMetaPixel = function (PID) {
        if(!(window.fbq&&window.fbq.loaded)){
          (function(f,b,e,v,n,t,s){if(f.fbq)return;n=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};n.queue=[];n.loaded=true;n.version='2.0';t=b.createElement(e);t.async=true;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s);f._fbq=f._fbq||n;f.fbq=n;})(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        }
        window.fbq&&window.fbq('set','autoConfig',false,PID);
        window.fbq&&window.fbq('disablePushState',true);
        if(!window.__pixelInitialized){ window.fbq&&window.fbq('init',PID); window.__pixelInitialized=true; }
        window.fbq&&window.fbq('track','PageView');
      };
    </script>
  </head>

  <body id="top">
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">Skip to content</a>

    <!-- bg image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920}
      class="absolute min-h-svh object-cover inset-0 bottom-auto -z-1 w-full h-auto opacity-20 mask-b-from-50%"
      loading="eager" />

    <!-- 1) HEADER STICKY + BLUR -->
    <header class="fx-sticky-header" data-reveal>
      <HeaderMain settings={ settings } lang={lang} />
    </header>

    <main id="main">
      <slot />
    </main>

    <!-- 3) SEPARATORE “vellutato” prima del footer -->
    <div class="fx-sep" aria-hidden="true"></div>

    <FooterMain settings={ settings } />

    <!-- Cookie banner e GDPR script rimangono identici a prima -->
    <!-- AUTO-SHOW banner -->
    <script is:inline>
      (function(){
        var key='fenles_consent_v1';
        var hasCookie=document.cookie.split('; ').some(c=>c.startsWith(key+'='));
        if(!hasCookie){ document.getElementById('cookieBanner')?.classList.add('show'); }
      })();
    </script>

    <!-- Accept / Reject / CTA tracking (come versione precedente) -->
    <script is:inline>
      window.__consentAccept=function(id){
        try{var v=encodeURIComponent(JSON.stringify({necessary:true,marketing:true,ts:Date.now()}));
          document.cookie='fenles_consent_v1='+v+'; Path=/; Expires='+new Date(Date.now()+31536e6).toUTCString()+'; SameSite=Lax';}catch(e){}
        document.getElementById('cookieBanner')?.classList.remove('show');
        (function(f,b,e,v,n,t,s){if(f.fbq)return;n=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          n.queue=[];n.loaded=true;n.version='2.0';t=b.createElement(e);t.async=true;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s);f._fbq=f._fbq||n;f.fbq=n;
        })(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        window.fbq&&window.fbq('set','autoConfig',false,id);
        window.fbq&&window.fbq('disablePushState',true);
        if(!window.__pixelInitialized){ window.fbq&&window.fbq('init',id); window.__pixelInitialized=true; }
        (function ensurePV(t){ if(window.fbq&&window.fbq.loaded){ window.fbq('track','PageView'); return; }
          if((t||0)<30) setTimeout(function(){ensurePV((t||0)+1)},150);
        })();
        try{ new Image().src="/api/fbpx?id="+id+"&ev=PageView&dl="+encodeURIComponent(location.href)+"&ts="+Date.now(); }catch(_){}
      };
      window.__consentReject=function(){
        try{var v=encodeURIComponent(JSON.stringify({necessary:true,marketing:false,ts:Date.now()}));
          document.cookie='fenles_consent_v1='+v+'; Path=/; Expires='+new Date(Date.now()+31536e6).toUTCString()+'; SameSite=Lax';}catch(e){}
        document.getElementById('cookieBanner')?.classList.remove('show');
        try{ window.__pixelInitialized=false; delete window.fbq; delete window._fbq; }catch(_){}
      };
      document.addEventListener('click',function(e){
        var btn=e.target.closest('a[data-cta]'); if(!btn) return;
        try{var c=window.fenlesConsent.get(); if(c&&c.marketing&&window.fbq) window.fbq('track','InitiateCheckout',{value:0,currency:'EUR'});}catch(_){}
      },{passive:true});
    </script>

    <!-- 4) REVEAL ON SCROLL leggero (pausa offscreen) -->
    <script is:inline>
      (function(){
        var els = document.querySelectorAll('[data-reveal]');
        if(!els.length) return;
        var io = new IntersectionObserver((entries)=>{
          entries.forEach(e=>{
            if(e.isIntersecting){ e.target.classList.add('is-revealed'); io.unobserve(e.target); }
          });
        },{root:null,threshold:.08});
        els.forEach(el=>io.observe(el));
      })();
    </script>
  </body>
</html>
