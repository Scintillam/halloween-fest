---
/**
 * LanguageSwitcher.astro
 * Props:
 *  - lang: "es" | "it" | "en"
 *  - class (opzionale)
 *
 * Evidenziazione basata su `lang`.
 * Preserva fbclid/gclid/utm/src nel cambio lingua.
 */
const { lang = "es", class: extraClass = "" } = Astro.props;

const KEEP = ["fbclid","gclid","utm_source","utm_medium","utm_campaign","utm_content","utm_term","src"];

let query = "";
try {
  // URL corrente (SSR safe)
  const u = new URL(Astro.request.url);
  const p = new URLSearchParams();
  for (const k of KEEP) {
    const v = u.searchParams.get(k);
    if (v) p.set(k, v);
  }
  const s = p.toString();
  query = s ? `?${s}` : "";
} catch { /* ignore in SSG */ }

const locales = [
  { code: "es", label: "Español", href: "/" },
  { code: "it", label: "Italiano", href: "/it/" },
  { code: "en", label: "English", href: "/en/" },
  { code: "ca", label: "Català", href: "/ca/" },
];
---
<nav class={`lang-switch ${extraClass}`} aria-label="Language switcher">
  {locales.map(l => (
    <a
      href={l.href + query}
      class:list={[
        "flag-btn",
        lang === l.code && "is-active"
      ]}
      aria-current={lang === l.code ? "page" : undefined}
      title={l.label}
    >
      <img src={`/assets/flags/${l.code}.svg`} width="22" height="22" alt={l.label} loading="lazy" decoding="async" style="display:block;height:auto" />
    </a>
  ))}
</nav>

<style>
  .lang-switch { display:flex; gap:.5rem; align-items:center }
  .flag-btn {
    display:inline-flex; align-items:center; justify-content:center;
    width:2rem; height:2rem; border-radius:999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    transition: transform .15s ease, filter .15s ease, box-shadow .2s ease, outline-color .2s ease;
    outline: 0 solid transparent;
  }
  .flag-btn:hover { transform: translateY(-1px); filter: brightness(1.08) }
  .flag-btn.is-active {
    outline-width: 2px;
    outline-color: color-mix(in oklab, #6C47FF, white 25%);
    box-shadow: 0 0 18px color-mix(in oklab, #6C47FF, white 20%);
  }
  @media (prefers-reduced-motion: reduce){
    .flag-btn, .flag-btn:hover { transform:none }
  }
</style>
